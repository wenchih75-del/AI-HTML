<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文單字測驗生成器</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f9; }
        .a4-page {
            /* 模擬 A4 尺寸 */
            width: 100%;
            max-width: 210mm;
            min-height: 297mm;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px 40px;
            margin: 20px auto;
            background-color: white;
            transition: all 0.3s ease;
            box-sizing: border-box;
            word-wrap: break-word;
        }

        .input-box {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }

        .interactive-word {
            display: inline-flex;
            margin-right: 0.8rem;
            gap: 1px;
            align-items: center;
        }

        .blank-space {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin: 0 1px;
            min-width: 0.5rem;
            text-align: center;
            border-bottom: 2px solid #1f2937;
            font-size: 0.8em;
            color: transparent;
            line-height: 1.2;
        }

        /* 列表樣式調整 */
        .quiz-item-li {
            padding-left: 0; 
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        @media print {
            body { background-color: white; }
            #controlPanel, #exportButtons, #headerMessage { display: none !important; }
            .main-container { padding: 0 !important; margin: 0 !important; }
            .a4-page {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 10mm !important;
                width: 210mm !important;
                min-height: 297mm !important;
                max-width: none !important;
            }
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        window.firebase = {
            db: null,
            auth: null,
            userId: null,
            appId: appId,
            addDoc, collection
        };

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            window.firebase.db = getFirestore(app);
            window.firebase.auth = getAuth(app);
        }

        if (window.firebase.auth) {
            onAuthStateChanged(window.firebase.auth, async (user) => {
                if (user) {
                    window.firebase.userId = user.uid;
                } else {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.firebase.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.firebase.auth);
                    }
                }
            });
        }
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="main-container max-w-7xl mx-auto flex flex-col lg:flex-row gap-8">
        
        <!-- 左欄: 即時顯示/A4 輸出區 -->
        <div class="lg:w-1/2 flex-shrink-0 flex justify-center">
            <div id="quizOutput" class="a4-page">
                <h1 class="text-3xl font-bold mb-4 text-gray-800 border-b pb-2 text-center">
                    英文單字測驗
                </h1>
                <p id="headerMessage" class="text-sm text-center text-indigo-500 mb-6 font-medium">
                    請在右側輸入單字並點擊「處理內容」。
                </p>
                <div id="quizContent" class="a4-content text-lg leading-relaxed text-gray-700" style="columns: 1;">
                    <!-- 測驗內容將在此處顯示 -->
                </div>
            </div>
        </div>

        <!-- 右欄: 控制與輸入區 -->
        <div id="controlPanel" class="lg:w-1/2 space-y-6">

            <div class="input-box space-y-4">
                <h2 class="text-xl font-semibold text-gray-800">1. 測驗內容輸入</h2>

                <!-- 檔案上傳 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">上傳 .txt 檔案</label>
                    <input type="file" id="fileUpload" accept=".txt" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <!-- 即時輸入 -->
                <div>
                    <label for="liveInput" class="block text-sm font-medium text-gray-700 mb-1">輸入英文單字 (可輸入無限多個)</label>
                    <textarea id="liveInput" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="apple&#10;banana&#10;cat&#10;dog..."></textarea>
                </div>

                <button id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                    處理內容並生成單字清單
                </button>
            </div>
            
            <!-- 1.5 英文對中文定義設定 -->
            <div class="input-box space-y-4">
                <h2 class="text-xl font-semibold text-gray-800">1.5. 中文定義 (選填)</h2>
                
                <button id="generateDefinitionsBtn" class="w-full py-2 px-4 rounded-lg bg-yellow-500 hover:bg-yellow-600 text-white text-base font-bold transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                    一鍵生成中文翻譯 (AI)
                </button>

                <div id="definitionPanel" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <p class="text-sm text-gray-500">清單將顯示於此處。</p>
                </div>
                
                <div class="flex items-center mt-4 pt-4 border-t border-gray-200">
                    <input type="checkbox" id="showDefinitions" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="showDefinitions" class="ml-2 block text-sm font-medium text-gray-700">在測驗輸出中顯示中文定義</label>
                </div>
            </div>

            <div class="input-box space-y-4">
                <h2 class="text-xl font-semibold text-gray-800">2. 版面與輸出</h2>
                
                <!-- 字體大小滑桿 -->
                <div>
                    <label for="fontSizeSlider" class="block text-sm font-medium text-gray-700 mb-2">
                        字體大小調整 (<span id="fontSizeValue">16</span>px)
                    </label>
                    <input type="range" id="fontSizeSlider" min="12" max="24" value="16" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                </div>

                <!-- 欄位切換按鈕 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">左欄顯示模式</label>
                    <div class="flex space-x-3">
                        <button id="cols1Btn" class="flex-1 py-2 px-4 rounded-lg border border-indigo-600 text-indigo-600 font-medium bg-indigo-50 hover:bg-indigo-100 transition duration-150 ease-in-out">
                            單欄模式
                        </button>
                        <button id="cols2Btn" class="flex-1 py-2 px-4 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-100 transition duration-150 ease-in-out">
                            兩欄模式
                        </button>
                    </div>
                </div>
                
                <!-- 匯出學生網頁按鈕 -->
                <div class="pt-4 border-t border-gray-200">
                    <button id="exportStudentHtmlBtn" class="w-full py-3 px-4 rounded-lg bg-teal-600 hover:bg-teal-700 text-white font-bold transition duration-150 ease-in-out flex items-center justify-center shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        匯出學生作答網頁 (.html)
                    </button>
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        此功能會下載一個獨立的網頁檔案。<br>
                        請將該檔案傳給學生，他們即可在平板或電腦上進行填空作答，並可聆聽發音。
                    </p>
                </div>
            </div>

            <!-- 輸出按鈕 -->
            <div id="exportButtons" class="input-box space-y-4">
                <h2 class="text-xl font-semibold text-gray-800">3. 存檔與列印</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button id="exportPDF" class="py-2 px-4 rounded-lg border border-red-600 text-red-600 font-bold hover:bg-red-50 transition duration-150 ease-in-out">
                        輸出為 PDF
                    </button>
                    <button id="exportWord" class="py-2 px-4 rounded-lg border border-blue-600 text-blue-600 font-bold hover:bg-blue-50 transition duration-150 ease-in-out">
                        輸出為 Word (.doc)
                    </button>
                </div>
                <button id="saveQuiz" class="w-full py-2 px-4 rounded-lg bg-amber-500 hover:bg-amber-600 text-white font-bold transition duration-150 ease-in-out">
                    輸出為暫存檔案模式 (雲端儲存)
                </button>
                <p id="saveMessage" class="text-sm text-center text-gray-500 hidden mt-2"></p>
            </div>
            
        </div>
    </div>

    <!-- 彈出訊息框 -->
    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold text-gray-800 mb-4" id="modalTitle">訊息</h3>
            <p class="text-gray-600 mb-6" id="modalBody"></p>
            <button id="modalCloseBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">確認</button>
        </div>
    </div>

    <script>
        // Global state
        let wordsData = [];
        let currentColumns = 1;
        const apiKey = ""; 

        // DOM elements
        const liveInput = document.getElementById('liveInput');
        const fileUpload = document.getElementById('fileUpload');
        const submitBtn = document.getElementById('submitBtn');
        const quizContent = document.getElementById('quizContent');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const cols1Btn = document.getElementById('cols1Btn');
        const cols2Btn = document.getElementById('cols2Btn');
        const exportPDF = document.getElementById('exportPDF');
        const exportWord = document.getElementById('exportWord');
        const saveQuiz = document.getElementById('saveQuiz');
        const saveMessage = document.getElementById('saveMessage');
        const headerMessage = document.getElementById('headerMessage');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const definitionPanel = document.getElementById('definitionPanel');
        const showDefinitionsCheckbox = document.getElementById('showDefinitions');
        const generateDefinitionsBtn = document.getElementById('generateDefinitionsBtn');
        const exportStudentHtmlBtn = document.getElementById('exportStudentHtmlBtn');

        // --- Utility Functions ---

        function showModal(title, body) {
            modalTitle.textContent = title;
            modalBody.textContent = body;
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
        }

        modalCloseBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
            messageModal.classList.remove('flex');
        });

        function slugify(text) {
            return text.toString().toLowerCase()
                .trim()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .substring(0, 50);
        }
        
        // --- TTS Helper Functions ---
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const numSamples = pcm16.length;
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);
            
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + numSamples * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true);
            view.setUint16(32, numChannels * 2, true); 
            view.setUint16(34, 16, true); 

            writeString(view, 36, 'data');
            view.setUint32(40, numSamples * 2, true);

            let offset = 44;
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        function playAudio(audioUrl) {
            if (audioUrl) {
                const audio = new Audio(audioUrl);
                audio.play();
            }
        }
        
        // --- TTS API with Updated Voice ---
        async function callTTSAPI(word) {
            const ttsBtn = document.querySelector(`button[data-word-text="${word}"]`);
            if (ttsBtn) {
                ttsBtn.disabled = true;
                ttsBtn.innerHTML = '<svg class="animate-spin h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            // CHANGED: Use "Aoede" for a more energetic/younger female tone
            const payload = {
                contents: [{ parts: [{ text: "Say cheerfully: " + word }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Aoede" } 
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let result = null;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    result = await response.json();
                }
            } catch (error) {
                console.error("TTS API Call Error:", error);
            }

            if (ttsBtn) {
                ttsBtn.disabled = false;
                ttsBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-indigo-600"><path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" /></svg>';
            }

            if (result && result.candidates && result.candidates.length > 0) {
                const part = result.candidates[0].content.parts[0];
                const audioData = part?.inlineData?.data;
                
                if (audioData) {
                    const sampleRate = 24000; // Aoede often uses 24k
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    return URL.createObjectURL(wavBlob);
                }
            }
            return null;
        }

        // --- AI Definition Generation ---
        
        async function generateDefinitions() {
            if (wordsData.length === 0) {
                showModal('操作提示', '請先生成單字清單。');
                return;
            }

            const genBtn = document.getElementById('generateDefinitionsBtn');
            genBtn.disabled = true;
            genBtn.textContent = '正在生成中...請稍候';

            const wordsList = wordsData.map(w => w.text);
            const userQuery = `Translate the following English words to Traditional Chinese. Provide only the most common single definition for each word in a concise manner. The words are: ${wordsList.join(', ')}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "word": { "type": "STRING", description: "The original English word." },
                                "translation": { "type": "STRING", description: "The concise Traditional Chinese translation." }
                            }
                        }
                    }
                },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    const translationMap = new Map();
                    parsedJson.forEach(item => {
                        translationMap.set(item.word.toLowerCase(), item.translation);
                    });
                    wordsData.forEach(wordItem => {
                        const translation = translationMap.get(wordItem.text);
                        if (translation) {
                            wordItem.chineseDefinition = translation;
                        }
                    });
                    renderDefinitionPanel();
                    renderQuiz();
                    showModal('翻譯完成', `已成功為 ${wordsData.length} 個單字生成中文翻譯。`);
                }
            } catch (error) {
                console.error("API Call Error:", error);
                showModal('自動翻譯錯誤', '無法連線到翻譯服務。');
            }
            genBtn.disabled = false;
            genBtn.textContent = '一鍵生成中文翻譯 (AI)';
        }


        // --- Core Logic: Processing and Rendering ---

        function processInput(text) {
            if (!text || text.trim() === '') {
                showModal('輸入錯誤', '請輸入有效的英文內容。');
                return;
            }

            // Simple cleaning: keep letters, spaces, and single quotes.
            const cleanText = text.replace(/[^a-zA-Z\s']/g, ' ').toLowerCase();
            const rawWords = cleanText.split(/\s+/).filter(w => w.length > 0);
            
            // CHANGED: Removed length filter > 4 and common words check to allow "unlimited" words
            const uniqueWordsMap = new Map();
            rawWords.forEach(word => {
                if (word.length >= 1) { // Only check if it's not empty
                    uniqueWordsMap.set(word, word);
                }
            });

            // Keep existing definitions
            const existingDefinitions = new Map(wordsData.map(w => [w.text, w.chineseDefinition]));

            wordsData = Array.from(uniqueWordsMap.keys()).map((word, index) => ({
                id: index + 1,
                text: word,
                blankState: Array(word.length).fill(false),
                chineseDefinition: existingDefinitions.get(word) || '' 
            }));
            
            headerMessage.textContent = `共有 ${wordsData.length} 個單字可供出題。點擊單字的「字母」即可挖空/還原。`;
            renderDefinitionPanel();
            renderQuiz();
        }

        function renderDefinitionPanel() {
            definitionPanel.innerHTML = '';
            if (wordsData.length === 0) {
                definitionPanel.innerHTML = '<p class="text-sm text-gray-500">清單顯示於此。</p>';
                generateDefinitionsBtn.disabled = true;
                return;
            }
            generateDefinitionsBtn.disabled = false;

            wordsData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                
                const wordLabel = document.createElement('span');
                wordLabel.className = 'font-bold text-gray-700 w-1/4 flex-shrink-0 truncate';
                wordLabel.textContent = `${item.id}. ${item.text}:`;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-3/4 p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500';
                input.placeholder = `中文翻譯`;
                input.value = item.chineseDefinition;
                input.setAttribute('data-id', item.id);
                
                input.addEventListener('input', (event) => {
                    const id = parseInt(event.target.getAttribute('data-id'));
                    const wordIndex = wordsData.findIndex(w => w.id === id);
                    if (wordIndex !== -1) {
                        wordsData[wordIndex].chineseDefinition = event.target.value.trim();
                        renderQuiz();
                    }
                });

                div.appendChild(wordLabel);
                div.appendChild(input);
                definitionPanel.appendChild(div);
            });
        }

        function renderQuiz() {
            quizContent.innerHTML = '';

            if (wordsData.length === 0) {
                quizContent.textContent = "目前沒有單字清單。";
                return;
            }

            const showDefinitions = showDefinitionsCheckbox.checked;
            
            // Container for list
            const list = document.createElement('div');
            list.className = 'flex flex-col gap-3 pl-2';
            
            wordsData.forEach(item => {
                const li = document.createElement('div');
                li.className = 'quiz-item-li text-lg';
                li.setAttribute('data-word-id-display', item.id); 
                
                // FIXED: Explicit Numbering Span (Item 1, 2, 3...)
                const numberSpan = document.createElement('span');
                numberSpan.className = 'font-bold text-gray-700 mr-2 min-w-[1.5rem] text-right';
                numberSpan.textContent = `${item.id}.`;
                li.appendChild(numberSpan);

                // English Word (Interactive)
                const wordWrapper = document.createElement('span');
                wordWrapper.setAttribute('data-id', item.id);
                wordWrapper.classList.add('interactive-word', 'font-mono', 'flex-shrink-0', 'mr-4');
                
                for(let i = 0; i < item.text.length; i++) {
                    const charSpan = document.createElement('span');
                    charSpan.setAttribute('data-char-index', i);
                    charSpan.setAttribute('data-word-id', item.id);
                    charSpan.classList.add('cursor-pointer', 'hover:bg-yellow-200', 'transition', 'duration-100', 'ease-in-out', 'px-0.5', 'rounded', 'font-mono');
                    charSpan.addEventListener('click', toggleLetterBlank);

                    if (item.blankState[i]) {
                        charSpan.innerHTML = '<span class="blank-space">_</span>';
                        charSpan.classList.add('text-gray-900', 'font-bold', 'bg-red-50');
                    } else {
                        charSpan.textContent = item.text[i];
                        charSpan.classList.add('text-indigo-600', 'font-medium');
                    }
                    wordWrapper.appendChild(charSpan);
                }

                li.appendChild(wordWrapper);

                // Chinese Definition (No Italic)
                const defText = item.chineseDefinition.trim();
                if (showDefinitions && defText !== '') {
                    const defSpan = document.createElement('span');
                    // CHANGED: not-italic class ensures text is upright
                    defSpan.className = 'text-sm text-gray-500 not-italic flex-shrink-0 min-w-[5rem] md:min-w-[10rem] mr-4';
                    defSpan.textContent = `(${defText})`;
                    li.appendChild(defSpan);
                }

                // TTS Button
                const ttsButton = document.createElement('button');
                ttsButton.type = 'button';
                ttsButton.title = '播放美式發音';
                ttsButton.className = 'p-1.5 rounded-full bg-indigo-100 hover:bg-indigo-200 transition duration-150 ease-in-out flex items-center justify-center flex-shrink-0';
                ttsButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-indigo-600"><path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" /></svg>';
                ttsButton.setAttribute('data-word-text', item.text);
                
                ttsButton.addEventListener('click', async (e) => {
                    const targetBtn = e.currentTarget;
                    const word = targetBtn.getAttribute('data-word-text');
                    let audioUrl = targetBtn.getAttribute('data-audio-url');

                    if (!audioUrl) {
                        audioUrl = await callTTSAPI(word);
                        if (audioUrl) {
                            targetBtn.setAttribute('data-audio-url', audioUrl);
                        } else {
                            return;
                        }
                    }
                    playAudio(audioUrl);
                });
                
                li.appendChild(ttsButton);
                list.appendChild(li);
            });

            quizContent.appendChild(list);
        }
        
        function toggleLetterBlank(event) {
            const wordId = parseInt(event.currentTarget.getAttribute('data-word-id'));
            const charIndex = parseInt(event.currentTarget.getAttribute('data-char-index'));
            
            const index = wordsData.findIndex(w => w.id === wordId);
            if (index !== -1) {
                const newState = !wordsData[index].blankState[charIndex];
                wordsData[index].blankState[charIndex] = newState;
                renderQuiz();
            }
        }

        // --- EXPORT STUDENT HTML ---
        function exportStudentHtml() {
            if (wordsData.length === 0) {
                showModal('匯出錯誤', '請先生成測驗內容。');
                return;
            }

            const exportData = wordsData.map(w => ({
                id: w.id,
                text: w.text,
                blankState: w.blankState,
                chineseDefinition: showDefinitionsCheckbox.checked ? w.chineseDefinition : ''
            }));

            // Embed TTS helper functions and logic into the exported HTML
            const htmlContent = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文單字測驗 (學生版)</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .quiz-container { max-width: 800px; margin: 40px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .interactive-word { display: inline-flex; gap: 1px; align-items: center; margin-right: 10px; }
        .student-input-char { width: 24px; height: 32px; text-align: center; border: none; border-bottom: 2px solid #cbd5e1; font-size: 1.2rem; margin: 0 1px; outline: none; background: transparent; }
        .student-input-char:focus { border-bottom-color: #4f46e5; }
        .correct { border-bottom-color: #22c55e !important; background-color: #f0fdf4; }
        .incorrect { border-bottom-color: #ef4444 !important; background-color: #fef2f2; }
    </style>
</head>
<body class="p-4">
    <div class="quiz-container">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">英文單字測驗</h1>
        <div id="quizContent" class="space-y-4"></div>
        <div class="mt-8 text-center">
            <button onclick="checkAnswers()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition">檢查答案</button>
            <p id="resultMessage" class="mt-4 text-lg font-bold"></p>
        </div>
    </div>

    <script>
        const apiKey = "${apiKey}"; 
        const wordsData = ${JSON.stringify(exportData)};

        // TTS Helpers embedded
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const numSamples = pcm16.length;
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + numSamples * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true);
            view.setUint16(32, numChannels * 2, true); 
            view.setUint16(34, 16, true); 
            writeString(view, 36, 'data');
            view.setUint32(40, numSamples * 2, true);
            let offset = 44;
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        function playAudio(audioUrl) {
            if (audioUrl) {
                const audio = new Audio(audioUrl);
                audio.play();
            }
        }

        async function callTTSAPI(word) {
            const ttsBtn = document.querySelector(\`button[data-word-text="\${word}"]\`);
            if (ttsBtn) ttsBtn.disabled = true;

            const apiUrl = \`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=\${apiKey}\`;
            const payload = {
                contents: [{ parts: [{ text: "Say cheerfully: " + word }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Aoede" } 
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let result = null;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    result = await response.json();
                }
            } catch (error) {
                console.error("TTS API Call Error:", error);
            }

            if (ttsBtn) ttsBtn.disabled = false;

            if (result && result.candidates && result.candidates.length > 0) {
                const part = result.candidates[0].content.parts[0];
                const audioData = part?.inlineData?.data;
                if (audioData) {
                    const sampleRate = 24000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    return URL.createObjectURL(wavBlob);
                }
            }
            return null;
        }

        function renderQuiz() {
            const container = document.getElementById('quizContent');
            wordsData.forEach(item => {
                const row = document.createElement('div');
                row.className = 'flex flex-wrap items-center';
                
                const num = document.createElement('span');
                num.className = 'font-bold text-gray-500 mr-2 min-w-[1.5rem] text-right';
                num.textContent = item.id + '.';
                row.appendChild(num);

                const wordDiv = document.createElement('div');
                wordDiv.className = 'interactive-word font-mono text-lg';
                
                for(let i=0; i<item.text.length; i++) {
                    if(item.blankState[i]) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.maxLength = 1;
                        input.className = 'student-input-char';
                        input.dataset.wordId = item.id;
                        input.dataset.charIndex = i;
                        input.oninput = (e) => handleInput(e);
                        input.onkeydown = (e) => handleNav(e);
                        wordDiv.appendChild(input);
                    } else {
                        const span = document.createElement('span');
                        span.textContent = item.text[i];
                        span.className = 'font-bold text-gray-800 px-0.5';
                        wordDiv.appendChild(span);
                    }
                }
                row.appendChild(wordDiv);

                if(item.chineseDefinition) {
                    const def = document.createElement('span');
                    def.className = 'text-gray-500 text-sm ml-2';
                    def.textContent = '(' + item.chineseDefinition + ')';
                    row.appendChild(def);
                }

                // TTS Button in Exported HTML
                const ttsButton = document.createElement('button');
                ttsButton.type = 'button';
                ttsButton.className = 'ml-2 p-1.5 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-600 transition flex items-center justify-center';
                ttsButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" /></svg>';
                ttsButton.dataset.wordText = item.text;
                ttsButton.onclick = async (e) => {
                    const btn = e.currentTarget;
                    const word = btn.dataset.wordText;
                    let url = btn.dataset.audioUrl;
                    if(!url) {
                        url = await callTTSAPI(word);
                        if(url) btn.dataset.audioUrl = url;
                    }
                    playAudio(url);
                };
                row.appendChild(ttsButton);

                container.appendChild(row);
            });
        }

        function handleInput(e) {
            e.target.value = e.target.value.toLowerCase();
            if(e.target.value) {
                const inputs = Array.from(document.querySelectorAll('.student-input-char'));
                const currIdx = inputs.indexOf(e.target);
                if(currIdx < inputs.length - 1) inputs[currIdx+1].focus();
            }
        }

        function handleNav(e) {
            const inputs = Array.from(document.querySelectorAll('.student-input-char'));
            const currIdx = inputs.indexOf(e.target);
            if(e.key === 'ArrowRight' && currIdx < inputs.length-1) inputs[currIdx+1].focus();
            if(e.key === 'ArrowLeft' && currIdx > 0) inputs[currIdx-1].focus();
            if(e.key === 'Backspace' && !e.target.value && currIdx > 0) inputs[currIdx-1].focus();
        }

        function checkAnswers() {
            let correct = 0;
            let total = 0;
            const inputs = document.querySelectorAll('.student-input-char');
            inputs.forEach(input => {
                total++;
                const wId = parseInt(input.dataset.wordId);
                const cIdx = parseInt(input.dataset.charIndex);
                const word = wordsData.find(w => w.id === wId);
                
                input.classList.remove('correct', 'incorrect');
                if(input.value.toLowerCase() === word.text[cIdx].toLowerCase()) {
                    correct++;
                    input.classList.add('correct');
                } else {
                    input.classList.add('incorrect');
                }
            });
            const score = total === 0 ? 0 : Math.round((correct/total)*100);
            const msg = document.getElementById('resultMessage');
            msg.textContent = '得分: ' + score + '% (' + correct + '/' + total + ')';
            msg.className = 'mt-4 text-lg font-bold ' + (score >= 80 ? 'text-green-600' : 'text-red-600');
        }

        renderQuiz();
    <\/script>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'student_quiz.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        exportStudentHtmlBtn.addEventListener('click', exportStudentHtml); // Bind event


        // --- Event Listeners for Controls ---
        
        generateDefinitionsBtn.addEventListener('click', generateDefinitions); // NEW: AI Definition Button

        // File Upload Handler
        fileUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { liveInput.value = e.target.result; fileUpload.value = ''; };
                reader.readAsText(file);
            }
        });

        // Submit Button
        submitBtn.addEventListener('click', () => {
            processInput(liveInput.value);
        });

        // Font Size Slider
        fontSizeSlider.addEventListener('input', (event) => {
            fontSizeValue.textContent = event.target.value;
            quizContent.style.fontSize = `${event.target.value}px`;
        });

        // Column Switch
        function setColumns(cols) {
            currentColumns = cols;
            quizContent.style.columns = cols;
            cols1Btn.className = `flex-1 py-2 px-4 rounded-lg font-medium transition duration-150 ease-in-out ${cols === 1 ? 'border border-indigo-600 text-indigo-600 bg-indigo-50 hover:bg-indigo-100' : 'border border-gray-300 text-gray-700 hover:bg-gray-100'}`;
            cols2Btn.className = `flex-1 py-2 px-4 rounded-lg font-medium transition duration-150 ease-in-out ${cols === 2 ? 'border border-indigo-600 text-indigo-600 bg-indigo-50 hover:bg-indigo-100' : 'border border-gray-300 text-gray-700 hover:bg-gray-100'}`;
        }
        cols1Btn.addEventListener('click', () => setColumns(1));
        cols2Btn.addEventListener('click', () => setColumns(2));
        
        showDefinitionsCheckbox.addEventListener('change', renderQuiz);

        // Export Buttons
        exportPDF.addEventListener('click', () => { setColumns(1); window.print(); });
        
        exportWord.addEventListener('click', () => {
            const content = document.getElementById('quizOutput').outerHTML;
            const htmlContent = `<!DOCTYPE html><html><head><meta charset='utf-8'><title>英文測驗</title></head><body>${content}</body></html>`;
            const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `English_Quiz_${slugify(wordsData.map(w => w.text).join('-')) || 'Draft'}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        saveQuiz.addEventListener('click', async () => {
            if (!window.firebase.db || !window.firebase.userId) {
                showModal('儲存錯誤', 'Firebase 尚未初始化完成，請稍候再試。');
                return;
            }
            if (wordsData.length === 0) return;
            
            saveMessage.textContent = '正在儲存中...';
            saveMessage.classList.remove('hidden');

            const quizData = {
                userId: window.firebase.userId,
                appId: window.firebase.appId,
                createdAt: new Date(),
                originalText: liveInput.value,
                wordsData: wordsData,
                columnMode: currentColumns,
                fontSize: fontSizeSlider.value,
                showDefinitions: showDefinitionsCheckbox.checked
            };

            try {
                const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, `artifacts/${window.firebase.appId}/public/data/english_quizzes`), quizData);
                const quizUrl = `#quizId=${docRef.id}`;
                saveMessage.innerHTML = `儲存成功！測驗 ID: <span class="font-bold text-indigo-600">${docRef.id}</span>。`;
            } catch (error) {
                console.error("Error saving: ", error);
                showModal('儲存失敗', error.message);
                saveMessage.textContent = '儲存失敗。';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            setColumns(currentColumns);
        });
    </script>
</body>
</html>
